document.addEventListener("DOMContentLoaded",function(){document.querySelectorAll('.fgb-fluid-group[data-fluid-enabled="true"]').forEach(function(e){const r=e.querySelector(".fgb-fluid-canvas");if(!r)return;const t=e.getAttribute("data-fluid-settings");let n={};try{n=JSON.parse(t)||{}}catch(e){console.error("Failed to parse fluid settings:",e)}!function(e,r){const t={SIM_RESOLUTION:r.simResolution||128,DYE_RESOLUTION:r.dyeResolution||1024,DENSITY_DISSIPATION:r.densityDissipation||.97,VELOCITY_DISSIPATION:r.velocityDissipation||.98,PRESSURE:r.pressure||.8,PRESSURE_ITERATIONS:20,CURL:r.curl||30,SPLAT_RADIUS:r.splatRadius||.25,SPLAT_FORCE:r.splatForce||6e3,BLOOM:!1!==r.bloom,BLOOM_ITERATIONS:8,BLOOM_RESOLUTION:256,BLOOM_INTENSITY:r.bloomIntensity||.8,BLOOM_THRESHOLD:r.bloomThreshold||.6,BLOOM_SOFT_KNEE:.7},n={saturation:r.colorSaturation||1,brightness:r.colorBrightness||.15,rainbowMode:!1!==r.rainbowMode,darkMode:r.darkMode||!1};class o{constructor(){this.id=-1,this.texcoordX=0,this.texcoordY=0,this.prevTexcoordX=0,this.prevTexcoordY=0,this.deltaX=0,this.deltaY=0,this.down=!1,this.moved=!1,this.color={r:.5,g:.2,b:.8}}}let i=[new o];function a(e,r,t,n,o){if(!function(e,r,t,n){const o=e.createTexture();e.bindTexture(e.TEXTURE_2D,o),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texImage2D(e.TEXTURE_2D,0,r,4,4,0,t,n,null);const i=e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,i),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,o,0);const a=e.checkFramebufferStatus(e.FRAMEBUFFER);return e.bindFramebuffer(e.FRAMEBUFFER,null),e.deleteFramebuffer(i),e.deleteTexture(o),a===e.FRAMEBUFFER_COMPLETE}(e,r,t,n)){if(o)switch(r){case e.R16F:return a(e,e.RG16F,e.RG,n,o);case e.RG16F:return a(e,e.RGBA16F,e.RGBA,n,o)}return{internalFormat:e.RGBA,format:e.RGBA}}return{internalFormat:r,format:t}}const u=function(e){const r={alpha:!0,depth:!1,stencil:!1,antialias:!1,preserveDrawingBuffer:!1};let t=e.getContext("webgl2",r);const n=!!t;if(n||(t=e.getContext("webgl",r)||e.getContext("experimental-webgl",r)),!t)return console.error("WebGL not supported"),null;let o,i,u,l,c;if(n)t.getExtension("EXT_color_buffer_float"),i=t.getExtension("OES_texture_float_linear"),o=t.HALF_FLOAT;else{const e=t.getExtension("OES_texture_half_float");o=e?e.HALF_FLOAT_OES:t.UNSIGNED_BYTE,i=t.getExtension("OES_texture_half_float_linear")}return t.clearColor(0,0,0,1),n?(u=a(t,t.RGBA16F,t.RGBA,o,n),l=a(t,t.RG16F,t.RG,o,n),c=a(t,t.R16F,t.RED,o,n)):(u={internalFormat:t.RGBA,format:t.RGBA},l={internalFormat:t.RGBA,format:t.RGBA},c={internalFormat:t.RGBA,format:t.RGBA}),{gl:t,ext:{formatRGBA:u,formatRG:l,formatR:c,halfFloatTexType:o,supportLinearFiltering:!!i},isWebGL2:n}}(e);if(!u)return;const{gl:l,ext:c,isWebGL2:f}=u;function v(e,r){const t=l.createShader(e);return l.shaderSource(t,r),l.compileShader(t),l.getShaderParameter(t,l.COMPILE_STATUS)?t:(console.error("Shader error:",l.getShaderInfoLog(t)),l.deleteShader(t),null)}function s(e,r){const t=v(l.VERTEX_SHADER,e),n=v(l.FRAGMENT_SHADER,r);if(!t||!n)return null;const o=l.createProgram();if(l.attachShader(o,t),l.attachShader(o,n),l.linkProgram(o),!l.getProgramParameter(o,l.LINK_STATUS))return console.error("Program error:",l.getProgramInfoLog(o)),null;const i={},a=l.getProgramParameter(o,l.ACTIVE_UNIFORMS);for(let e=0;e<a;e++){const r=l.getActiveUniform(o,e).name;i[r]=l.getUniformLocation(o,r)}return{program:o,uniforms:i}}const m="\n        precision highp float;\n        attribute vec2 aPosition;\n        varying vec2 vUv;\n        varying vec2 vL;\n        varying vec2 vR;\n        varying vec2 vT;\n        varying vec2 vB;\n        uniform vec2 texelSize;\n        \n        void main () {\n            vUv = aPosition * 0.5 + 0.5;\n            vL = vUv - vec2(texelSize.x, 0.0);\n            vR = vUv + vec2(texelSize.x, 0.0);\n            vT = vUv + vec2(0.0, texelSize.y);\n            vB = vUv - vec2(0.0, texelSize.y);\n            gl_Position = vec4(aPosition, 0.0, 1.0);\n        }\n    ",d="\n        precision highp float;\n        attribute vec2 aPosition;\n        varying vec2 vUv;\n        varying vec2 vL;\n        varying vec2 vR;\n        uniform vec2 texelSize;\n        \n        void main () {\n            vUv = aPosition * 0.5 + 0.5;\n            float offset = 1.33333333;\n            vL = vUv - texelSize * offset;\n            vR = vUv + texelSize * offset;\n            gl_Position = vec4(aPosition, 0.0, 1.0);\n        }\n    ",g={copy:s(m,"\n        precision mediump float;\n        varying vec2 vUv;\n        uniform sampler2D uTexture;\n        \n        void main () {\n            gl_FragColor = texture2D(uTexture, vUv);\n        }\n    "),clear:s(m,"\n        precision mediump float;\n        varying vec2 vUv;\n        uniform sampler2D uTexture;\n        uniform float value;\n        \n        void main () {\n            gl_FragColor = value * texture2D(uTexture, vUv);\n        }\n    "),display:s(m,"\n        precision highp float;\n        varying vec2 vUv;\n        uniform sampler2D uTexture;\n        uniform sampler2D uBloom;\n        uniform bool useBloom;\n        \n        void main () {\n            vec3 c = texture2D(uTexture, vUv).rgb;\n            if (useBloom) {\n                vec3 bloom = texture2D(uBloom, vUv).rgb;\n                c += bloom;\n            }\n            float a = max(c.r, max(c.g, c.b));\n            gl_FragColor = vec4(c, a);\n        }\n    "),bloomPrefilter:s(m,"\n        precision mediump float;\n        varying vec2 vUv;\n        uniform sampler2D uTexture;\n        uniform vec3 curve;\n        uniform float threshold;\n        \n        void main () {\n            vec3 c = texture2D(uTexture, vUv).rgb;\n            float br = max(c.r, max(c.g, c.b));\n            float rq = clamp(br - curve.x, 0.0, curve.y);\n            rq = curve.z * rq * rq;\n            c *= max(rq, br - threshold) / max(br, 0.0001);\n            gl_FragColor = vec4(c, 0.0);\n        }\n    "),bloomBlur:s(d,"\n        precision mediump float;\n        varying vec2 vL;\n        varying vec2 vR;\n        varying vec2 vUv;\n        uniform sampler2D uTexture;\n        \n        void main () {\n            vec4 sum = vec4(0.0);\n            sum += texture2D(uTexture, vL);\n            sum += texture2D(uTexture, vR);\n            sum *= 0.5;\n            gl_FragColor = sum;\n        }\n    "),bloomFinal:s(d,"\n        precision mediump float;\n        varying vec2 vL;\n        varying vec2 vR;\n        varying vec2 vUv;\n        uniform sampler2D uTexture;\n        uniform float intensity;\n        \n        void main () {\n            vec4 sum = vec4(0.0);\n            sum += texture2D(uTexture, vL);\n            sum += texture2D(uTexture, vR);\n            sum *= 0.5 * intensity;\n            gl_FragColor = sum;\n        }\n    "),splat:s(m,"\n        precision highp float;\n        varying vec2 vUv;\n        uniform sampler2D uTarget;\n        uniform float aspectRatio;\n        uniform vec3 color;\n        uniform vec2 point;\n        uniform float radius;\n        \n        void main () {\n            vec2 p = vUv - point.xy;\n            p.x *= aspectRatio;\n            vec3 splat = exp(-dot(p, p) / radius) * color;\n            vec3 base = texture2D(uTarget, vUv).xyz;\n            gl_FragColor = vec4(base + splat, 1.0);\n        }\n    "),advection:s(m,"\n        precision highp float;\n        varying vec2 vUv;\n        uniform sampler2D uVelocity;\n        uniform sampler2D uSource;\n        uniform vec2 texelSize;\n        uniform vec2 dyeTexelSize;\n        uniform float dt;\n        uniform float dissipation;\n        \n        void main () {\n            vec2 coord = vUv - dt * texture2D(uVelocity, vUv).xy * texelSize;\n            vec4 result = texture2D(uSource, coord);\n            float decay = 1.0 + dissipation * dt;\n            gl_FragColor = result / decay;\n        }\n    "),divergence:s(m,"\n        precision mediump float;\n        varying vec2 vUv;\n        varying vec2 vL;\n        varying vec2 vR;\n        varying vec2 vT;\n        varying vec2 vB;\n        uniform sampler2D uVelocity;\n        \n        void main () {\n            float L = texture2D(uVelocity, vL).x;\n            float R = texture2D(uVelocity, vR).x;\n            float T = texture2D(uVelocity, vT).y;\n            float B = texture2D(uVelocity, vB).y;\n            vec2 C = texture2D(uVelocity, vUv).xy;\n            if (vL.x < 0.0) { L = -C.x; }\n            if (vR.x > 1.0) { R = -C.x; }\n            if (vT.y > 1.0) { T = -C.y; }\n            if (vB.y < 0.0) { B = -C.y; }\n            float div = 0.5 * (R - L + T - B);\n            gl_FragColor = vec4(div, 0.0, 0.0, 1.0);\n        }\n    "),curl:s(m,"\n        precision mediump float;\n        varying vec2 vUv;\n        varying vec2 vL;\n        varying vec2 vR;\n        varying vec2 vT;\n        varying vec2 vB;\n        uniform sampler2D uVelocity;\n        \n        void main () {\n            float L = texture2D(uVelocity, vL).y;\n            float R = texture2D(uVelocity, vR).y;\n            float T = texture2D(uVelocity, vT).x;\n            float B = texture2D(uVelocity, vB).x;\n            float vorticity = R - L - T + B;\n            gl_FragColor = vec4(0.5 * vorticity, 0.0, 0.0, 1.0);\n        }\n    "),vorticity:s(m,"\n        precision highp float;\n        varying vec2 vUv;\n        varying vec2 vL;\n        varying vec2 vR;\n        varying vec2 vT;\n        varying vec2 vB;\n        uniform sampler2D uVelocity;\n        uniform sampler2D uCurl;\n        uniform float curl;\n        uniform float dt;\n        \n        void main () {\n            float L = texture2D(uCurl, vL).x;\n            float R = texture2D(uCurl, vR).x;\n            float T = texture2D(uCurl, vT).x;\n            float B = texture2D(uCurl, vB).x;\n            float C = texture2D(uCurl, vUv).x;\n            vec2 force = 0.5 * vec2(abs(T) - abs(B), abs(R) - abs(L));\n            force /= length(force) + 0.0001;\n            force *= curl * C;\n            force.y *= -1.0;\n            vec2 vel = texture2D(uVelocity, vUv).xy;\n            gl_FragColor = vec4(vel + force * dt, 0.0, 1.0);\n        }\n    "),pressure:s(m,"\n        precision mediump float;\n        varying vec2 vUv;\n        varying vec2 vL;\n        varying vec2 vR;\n        varying vec2 vT;\n        varying vec2 vB;\n        uniform sampler2D uPressure;\n        uniform sampler2D uDivergence;\n        \n        void main () {\n            float L = texture2D(uPressure, vL).x;\n            float R = texture2D(uPressure, vR).x;\n            float T = texture2D(uPressure, vT).x;\n            float B = texture2D(uPressure, vB).x;\n            float C = texture2D(uPressure, vUv).x;\n            float divergence = texture2D(uDivergence, vUv).x;\n            float pressure = (L + R + B + T - divergence) * 0.25;\n            gl_FragColor = vec4(pressure, 0.0, 0.0, 1.0);\n        }\n    "),gradientSubtract:s(m,"\n        precision mediump float;\n        varying vec2 vUv;\n        varying vec2 vL;\n        varying vec2 vR;\n        varying vec2 vT;\n        varying vec2 vB;\n        uniform sampler2D uPressure;\n        uniform sampler2D uVelocity;\n        \n        void main () {\n            float L = texture2D(uPressure, vL).x;\n            float R = texture2D(uPressure, vR).x;\n            float T = texture2D(uPressure, vT).x;\n            float B = texture2D(uPressure, vB).x;\n            vec2 velocity = texture2D(uVelocity, vUv).xy;\n            velocity.xy -= vec2(R - L, T - B);\n            gl_FragColor = vec4(velocity, 0.0, 1.0);\n        }\n    ")},T=l.createBuffer();l.bindBuffer(l.ARRAY_BUFFER,T),l.bufferData(l.ARRAY_BUFFER,new Float32Array([-1,-1,-1,1,1,1,1,-1]),l.STATIC_DRAW);const x=l.createBuffer();function h(e,r=!1){null==e?(l.viewport(0,0,l.drawingBufferWidth,l.drawingBufferHeight),l.bindFramebuffer(l.FRAMEBUFFER,null)):(l.viewport(0,0,e.width,e.height),l.bindFramebuffer(l.FRAMEBUFFER,e.fbo)),r&&(l.clearColor(0,0,0,1),l.clear(l.COLOR_BUFFER_BIT)),l.bindBuffer(l.ARRAY_BUFFER,T),l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,x),l.enableVertexAttribArray(0),l.vertexAttribPointer(0,2,l.FLOAT,!1,0,0),l.drawElements(l.TRIANGLES,6,l.UNSIGNED_SHORT,0)}let E,R,p,S,y,_;l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,x),l.bufferData(l.ELEMENT_ARRAY_BUFFER,new Uint16Array([0,1,2,0,2,3]),l.STATIC_DRAW);let D=[];function F(e){let r=l.drawingBufferWidth/l.drawingBufferHeight;r<1&&(r=1/r);const t=Math.round(e),n=Math.round(e*r);return l.drawingBufferWidth>l.drawingBufferHeight?{width:n,height:t}:{width:t,height:n}}function b(e,r,t,n,o,i){l.activeTexture(l.TEXTURE0);const a=l.createTexture();l.bindTexture(l.TEXTURE_2D,a),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MIN_FILTER,i),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MAG_FILTER,i),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE),l.texImage2D(l.TEXTURE_2D,0,t,e,r,0,n,o,null);const u=l.createFramebuffer();return l.bindFramebuffer(l.FRAMEBUFFER,u),l.framebufferTexture2D(l.FRAMEBUFFER,l.COLOR_ATTACHMENT0,l.TEXTURE_2D,a,0),l.viewport(0,0,e,r),l.clear(l.COLOR_BUFFER_BIT),{texture:a,fbo:u,width:e,height:r,texelSizeX:1/e,texelSizeY:1/r,attach:e=>(l.activeTexture(l.TEXTURE0+e),l.bindTexture(l.TEXTURE_2D,a),e)}}function B(e,r,t,n,o,i){let a=b(e,r,t,n,o,i),u=b(e,r,t,n,o,i);return{width:e,height:r,texelSizeX:a.texelSizeX,texelSizeY:a.texelSizeY,get read(){return a},set read(e){a=e},get write(){return u},set write(e){u=e},swap(){const e=a;a=u,u=e}}}function L(){const r=e.parentElement.getBoundingClientRect(),t=Math.floor(r.width),n=Math.floor(r.height);return(e.width!==t||e.height!==n)&&(e.width=t,e.height=n,!0)}function U(){const e=F(t.SIM_RESOLUTION),r=F(t.DYE_RESOLUTION),n=c.halfFloatTexType,o=c.formatRGBA,i=c.formatRG,a=c.formatR,u=c.supportLinearFiltering?l.LINEAR:l.NEAREST;E=B(r.width,r.height,o.internalFormat,o.format,n,u),R=B(e.width,e.height,i.internalFormat,i.format,n,u),p=b(e.width,e.height,a.internalFormat,a.format,n,l.NEAREST),S=b(e.width,e.height,a.internalFormat,a.format,n,l.NEAREST),y=B(e.width,e.height,a.internalFormat,a.format,n,l.NEAREST),function(){const e=F(t.BLOOM_RESOLUTION),r=c.halfFloatTexType,n=c.formatRGBA,o=c.supportLinearFiltering?l.LINEAR:l.NEAREST;_=b(e.width,e.height,n.internalFormat,n.format,r,o),D.length=0;for(let i=0;i<t.BLOOM_ITERATIONS;i++){const t=e.width>>i+1,a=e.height>>i+1;if(t<2||a<2)break;const u=b(t,a,n.internalFormat,n.format,r,o);D.push(u)}}()}function A(){let e;return e=n.rainbowMode?function(e,r,t){let n,o,i;const a=Math.floor(6*e),u=6*e-a,l=t*(1-r),c=t*(1-u*r),f=t*(1-(1-u)*r);switch(a%6){case 0:n=t,o=f,i=l;break;case 1:n=c,o=t,i=l;break;case 2:n=l,o=t,i=f;break;case 3:n=l,o=c,i=t;break;case 4:n=f,o=l,i=t;break;case 5:n=t,o=l,i=c}return{r:n,g:o,b:i}}(Math.random(),n.saturation,1):{r:1,g:0,b:1},e.r*=n.brightness,e.g*=n.brightness,e.b*=n.brightness,n.darkMode&&(e.r=-e.r,e.g=-e.g,e.b=-e.b),e}L(),U();let O=Date.now();function P(r,n,o,i,a){l.useProgram(g.splat.program),l.uniform1i(g.splat.uniforms.uTarget,R.read.attach(0)),l.uniform1f(g.splat.uniforms.aspectRatio,e.width/e.height),l.uniform2f(g.splat.uniforms.point,r,n),l.uniform3f(g.splat.uniforms.color,o,i,0),l.uniform1f(g.splat.uniforms.radius,function(r){const t=e.width/e.height;return t>1&&(r*=t),r}(t.SPLAT_RADIUS/100)),h(R.write),R.swap(),l.uniform1i(g.splat.uniforms.uTarget,E.read.attach(0)),l.uniform3f(g.splat.uniforms.color,a.r,a.g,a.b),h(E.write),E.swap()}function w(r,t,n,o){r.id=t,r.down=!0,r.moved=!1,r.texcoordX=n/e.width,r.texcoordY=1-o/e.height,r.prevTexcoordX=r.texcoordX,r.prevTexcoordY=r.texcoordY,r.deltaX=0,r.deltaY=0,r.color=A()}function M(r,t,n){r.prevTexcoordX=r.texcoordX,r.prevTexcoordY=r.texcoordY,r.texcoordX=t/e.width,r.texcoordY=1-n/e.height,r.deltaX=function(r){const t=e.width/e.height;return t<1&&(r*=t),r}(r.texcoordX-r.prevTexcoordX),r.deltaY=function(r){const t=e.width/e.height;return t>1&&(r/=t),r}(r.texcoordY-r.prevTexcoordY),r.moved=Math.abs(r.deltaX)>0||Math.abs(r.deltaY)>0,r.moved&&(r.color=A())}e.addEventListener("mousemove",r=>{const t=i[0],n=e.getBoundingClientRect();M(t,r.clientX-n.left,r.clientY-n.top)}),e.addEventListener("mousedown",()=>{const e=i[0];e.down=!0,e.color=A()}),e.addEventListener("mouseup",()=>{i[0].down=!1}),e.addEventListener("touchstart",r=>{r.preventDefault();const t=r.targetTouches;for(;t.length>=i.length;)i.push(new o);for(let r=0;r<t.length;r++){const n=e.getBoundingClientRect(),o=t[r].clientX-n.left,a=t[r].clientY-n.top;w(i[r+1],t[r].identifier,o,a)}}),e.addEventListener("touchmove",r=>{r.preventDefault();const t=r.targetTouches;for(let r=0;r<t.length;r++){const n=i[r+1];if(!n||!n.down)continue;const o=e.getBoundingClientRect();M(n,t[r].clientX-o.left,t[r].clientY-o.top)}},!1),e.addEventListener("touchend",e=>{const r=e.changedTouches;for(let e=0;e<r.length;e++){const t=i.find(t=>t.id===r[e].identifier);t&&(t.down=!1)}}),function(e){for(let r=0;r<e;r++){const e=A();e.r*=10,e.g*=10,e.b*=10,P(Math.random(),Math.random(),1e3*(Math.random()-.5),1e3*(Math.random()-.5),e)}}(parseInt(5*Math.random())+5),function e(){const r=function(){const e=Date.now();let r=(e-O)/1e3;return r=Math.min(r,.016666),O=e,r}();var n;L()&&U(),i.forEach(e=>{e.moved&&(e.moved=!1,function(e){const r=e.deltaX*t.SPLAT_FORCE,n=e.deltaY*t.SPLAT_FORCE;P(e.texcoordX,e.texcoordY,r,n,e.color)}(e))}),function(e){l.disable(l.BLEND),l.useProgram(g.curl.program),l.uniform2f(g.curl.uniforms.texelSize,R.texelSizeX,R.texelSizeY),l.uniform1i(g.curl.uniforms.uVelocity,R.read.attach(0)),h(S),l.useProgram(g.vorticity.program),l.uniform2f(g.vorticity.uniforms.texelSize,R.texelSizeX,R.texelSizeY),l.uniform1i(g.vorticity.uniforms.uVelocity,R.read.attach(0)),l.uniform1i(g.vorticity.uniforms.uCurl,S.attach(1)),l.uniform1f(g.vorticity.uniforms.curl,t.CURL),l.uniform1f(g.vorticity.uniforms.dt,e),h(R.write),R.swap(),l.useProgram(g.divergence.program),l.uniform2f(g.divergence.uniforms.texelSize,R.texelSizeX,R.texelSizeY),l.uniform1i(g.divergence.uniforms.uVelocity,R.read.attach(0)),h(p),l.useProgram(g.clear.program),l.uniform1i(g.clear.uniforms.uTexture,y.read.attach(0)),l.uniform1f(g.clear.uniforms.value,t.PRESSURE),h(y.write),y.swap(),l.useProgram(g.pressure.program),l.uniform2f(g.pressure.uniforms.texelSize,R.texelSizeX,R.texelSizeY),l.uniform1i(g.pressure.uniforms.uDivergence,p.attach(0));for(let e=0;e<t.PRESSURE_ITERATIONS;e++)l.uniform1i(g.pressure.uniforms.uPressure,y.read.attach(1)),h(y.write),y.swap();l.useProgram(g.gradientSubtract.program),l.uniform2f(g.gradientSubtract.uniforms.texelSize,R.texelSizeX,R.texelSizeY),l.uniform1i(g.gradientSubtract.uniforms.uPressure,y.read.attach(0)),l.uniform1i(g.gradientSubtract.uniforms.uVelocity,R.read.attach(1)),h(R.write),R.swap(),l.useProgram(g.advection.program),l.uniform2f(g.advection.uniforms.texelSize,R.texelSizeX,R.texelSizeY),l.uniform2f(g.advection.uniforms.dyeTexelSize,R.texelSizeX,R.texelSizeY);const r=R.read.attach(0);l.uniform1i(g.advection.uniforms.uVelocity,r),l.uniform1i(g.advection.uniforms.uSource,r),l.uniform1f(g.advection.uniforms.dt,e),l.uniform1f(g.advection.uniforms.dissipation,t.VELOCITY_DISSIPATION),h(R.write),R.swap(),l.uniform2f(g.advection.uniforms.dyeTexelSize,E.texelSizeX,E.texelSizeY),l.uniform1i(g.advection.uniforms.uVelocity,R.read.attach(0)),l.uniform1i(g.advection.uniforms.uSource,E.read.attach(1)),l.uniform1f(g.advection.uniforms.dissipation,t.DENSITY_DISSIPATION),h(E.write),E.swap()}(r),n=null,t.BLOOM&&D.length>=2&&function(e,r){if(D.length<2)return;let n=r;l.disable(l.BLEND),l.useProgram(g.bloomPrefilter.program);const o=t.BLOOM_THRESHOLD*t.BLOOM_SOFT_KNEE+1e-4,i=t.BLOOM_THRESHOLD-o,a=2*o,u=.25/o;l.uniform3f(g.bloomPrefilter.uniforms.curve,i,a,u),l.uniform1f(g.bloomPrefilter.uniforms.threshold,t.BLOOM_THRESHOLD),l.uniform1i(g.bloomPrefilter.uniforms.uTexture,e.attach(0)),h(n),l.useProgram(g.bloomBlur.program);for(let e=0;e<D.length;e++){const r=D[e];l.uniform2f(g.bloomBlur.uniforms.texelSize,n.texelSizeX,n.texelSizeY),l.uniform1i(g.bloomBlur.uniforms.uTexture,n.attach(0)),h(r),n=r}l.blendFunc(l.ONE,l.ONE),l.enable(l.BLEND);for(let e=D.length-2;e>=0;e--){const r=D[e];l.uniform2f(g.bloomBlur.uniforms.texelSize,n.texelSizeX,n.texelSizeY),l.uniform1i(g.bloomBlur.uniforms.uTexture,n.attach(0)),l.viewport(0,0,r.width,r.height),h(r),n=r}l.disable(l.BLEND),l.useProgram(g.bloomFinal.program),l.uniform2f(g.bloomFinal.uniforms.texelSize,n.texelSizeX,n.texelSizeY),l.uniform1i(g.bloomFinal.uniforms.uTexture,n.attach(0)),l.uniform1f(g.bloomFinal.uniforms.intensity,t.BLOOM_INTENSITY),h(r)}(E.read,_),function(e){const r=null==e?l.drawingBufferWidth:e.width,n=null==e?l.drawingBufferHeight:e.height;l.useProgram(g.display.program),l.uniform2f(g.display.uniforms.texelSize,1/r,1/n),l.uniform1i(g.display.uniforms.uTexture,E.read.attach(0)),t.BLOOM&&D.length>=2?(l.uniform1i(g.display.uniforms.uBloom,_.attach(1)),l.uniform1i(g.display.uniforms.useBloom,1)):l.uniform1i(g.display.uniforms.useBloom,0),h(e)}(n),requestAnimationFrame(e)}()}(r,n)})});