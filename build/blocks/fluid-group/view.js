document.addEventListener("DOMContentLoaded",function(){document.querySelectorAll('.fgb-fluid-group[data-fluid-enabled="true"]').forEach(function(e){const t=e.querySelector(".fgb-fluid-canvas");if(!t)return;const r=e.getAttribute("data-fluid-settings");let n={};try{n=JSON.parse(r)||{}}catch(e){console.error("Failed to parse fluid settings:",e)}!function(e,t){var r,n,o,i,a,l,u,c,s,f,d,m,v,g,h,x,p,T,E,R,S,b,y,D,F,w,_,L,B,M,A,O,U,C,P,I,N,X,Y,z,G,k,V,H,W,q;const J={SIM_RESOLUTION:null!==(r=t.simResolution)&&void 0!==r?r:128,DYE_RESOLUTION:null!==(n=t.dyeResolution)&&void 0!==n?n:1024,DENSITY_DISSIPATION:null!==(o=t.densityDissipation)&&void 0!==o?o:.97,VELOCITY_DISSIPATION:null!==(i=t.velocityDissipation)&&void 0!==i?i:.98,PRESSURE:null!==(a=t.pressure)&&void 0!==a?a:.8,PRESSURE_ITERATIONS:20,CURL:null!==(l=t.curl)&&void 0!==l?l:30,SPLAT_RADIUS:null!==(u=t.splatRadius)&&void 0!==u?u:.25,SPLAT_FORCE:null!==(c=t.splatForce)&&void 0!==c?c:6e3,PROJECTION_DISTANCE:null!==(s=t.projectionDistance)&&void 0!==s?s:1,FADE_SPEED:null!==(f=t.fadeSpeed)&&void 0!==f?f:1,BLOOM:!1!==t.bloom,BLOOM_ITERATIONS:8,BLOOM_RESOLUTION:256,BLOOM_INTENSITY:null!==(d=t.bloomIntensity)&&void 0!==d?d:.8,BLOOM_THRESHOLD:null!==(m=t.bloomThreshold)&&void 0!==m?m:.6,BLOOM_SOFT_KNEE:.7,CALM_DOWN:null!==(v=t.calmDown)&&void 0!==v&&v,CALM_DOWN_DELAY:null!==(g=t.calmDownDelay)&&void 0!==g?g:2e3,CALM_DOWN_STRENGTH:null!==(h=t.calmDownStrength)&&void 0!==h?h:.9},K={saturation:null!==(x=t.colorSaturation)&&void 0!==x?x:1,brightness:null!==(p=t.colorBrightness)&&void 0!==p?p:.15,saturationBoost:null!==(T=t.saturationBoost)&&void 0!==T?T:1,fixedColor:null!==(E=t.fixedColor)&&void 0!==E?E:"#ff00ff",colorChangeDistance:null!==(R=t.colorChangeDistance)&&void 0!==R?R:0,colorMode:null!==(S=t.colorMode)&&void 0!==S?S:"rainbow",hueMin:null!==(b=t.hueMin)&&void 0!==b?b:0,hueMax:null!==(y=t.hueMax)&&void 0!==y?y:360,gradientSpeed:null!==(D=t.gradientSpeed)&&void 0!==D?D:.5,rainbowMode:!1!==t.rainbowMode,preventOverblending:null!==(F=t.preventOverblending)&&void 0!==F&&F,maxColorIntensity:null!==(w=t.maxColorIntensity)&&void 0!==w?w:1,darkMode:null!==(_=t.darkMode)&&void 0!==_&&_,blendMode:null!==(L=t.blendMode)&&void 0!==L?L:"normal",negativeBloom:null!==(B=t.negativeBloom)&&void 0!==B&&B},j=t.elementInteraction||{},$={enabled:null!==(M=j.enabled)&&void 0!==M&&M,selectors:null!==(A=j.selectors)&&void 0!==A?A:"",trackScroll:null!==(O=j.trackScroll)&&void 0!==O&&O,mode:null!==(U=j.mode)&&void 0!==U?U:"hardCorner",softEdgeRadius:null!==(C=j.softEdgeRadius)&&void 0!==C?C:20,forceFieldStrength:null!==(P=j.forceFieldStrength)&&void 0!==P?P:50,forceFieldRadius:null!==(I=j.forceFieldRadius)&&void 0!==I?I:80,attractFieldStrength:null!==(N=j.attractFieldStrength)&&void 0!==N?N:50,attractFieldRadius:null!==(X=j.attractFieldRadius)&&void 0!==X?X:80,turbulenceIntensity:null!==(Y=j.turbulenceIntensity)&&void 0!==Y?Y:30,turbulenceScale:null!==(z=j.turbulenceScale)&&void 0!==z?z:50,affectNewSplats:!1!==j.affectNewSplats,affectExistingFluid:null!==(G=j.affectExistingFluid)&&void 0!==G&&G,edgeGlow:null!==(k=j.edgeGlow)&&void 0!==k&&k,edgeGlowIntensity:null!==(V=j.edgeGlowIntensity)&&void 0!==V?V:.5,edgeGlowDistance:null!==(H=j.edgeGlowDistance)&&void 0!==H?H:15,edgeGlowMatchFluid:null===(W=j.edgeGlowMatchFluid)||void 0===W||W,edgeGlowColor:null!==(q=j.edgeGlowColor)&&void 0!==q?q:"#ffffff"};let Q=[];function Z(){if($.enabled&&$.selectors)try{const t=document.querySelectorAll($.selectors);Q=Array.from(t).map(t=>function(t){const r=e.getBoundingClientRect(),n=t.getBoundingClientRect();return{x:(n.left-r.left)/r.width,y:1-(n.bottom-r.top)/r.height,width:n.width/r.width,height:n.height/r.height,px:n.left-r.left,py:n.top-r.top,pWidth:n.width,pHeight:n.height}}(t))}catch(e){console.warn("Invalid element selectors:",e),Q=[]}else Q=[]}let ee=Math.random(),te=Date.now();e.style.mixBlendMode=K.blendMode,K.negativeBloom&&(e.style.filter="invert(1)");class re{constructor(){this.id=-1,this.texcoordX=0,this.texcoordY=0,this.prevTexcoordX=0,this.prevTexcoordY=0,this.deltaX=0,this.deltaY=0,this.down=!1,this.moved=!1,this.color={r:.5,g:.2,b:.8},this.distanceSinceColorChange=0}}let ne=[new re];function oe(e,t,r,n,o){if(!function(e,t,r,n){const o=e.createTexture();e.bindTexture(e.TEXTURE_2D,o),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texImage2D(e.TEXTURE_2D,0,t,4,4,0,r,n,null);const i=e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,i),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,o,0);const a=e.checkFramebufferStatus(e.FRAMEBUFFER);return e.bindFramebuffer(e.FRAMEBUFFER,null),e.deleteFramebuffer(i),e.deleteTexture(o),a===e.FRAMEBUFFER_COMPLETE}(e,t,r,n)){if(o)switch(t){case e.R16F:return oe(e,e.RG16F,e.RG,n,o);case e.RG16F:return oe(e,e.RGBA16F,e.RGBA,n,o)}return{internalFormat:e.RGBA,format:e.RGBA}}return{internalFormat:t,format:r}}const ie=function(e){const t={alpha:!0,depth:!1,stencil:!1,antialias:!1,preserveDrawingBuffer:!1};let r=e.getContext("webgl2",t);const n=!!r;if(n||(r=e.getContext("webgl",t)||e.getContext("experimental-webgl",t)),!r)return console.error("WebGL not supported"),null;let o,i,a,l,u;if(n)r.getExtension("EXT_color_buffer_float"),i=r.getExtension("OES_texture_float_linear"),o=r.HALF_FLOAT;else{const e=r.getExtension("OES_texture_half_float");o=e?e.HALF_FLOAT_OES:r.UNSIGNED_BYTE,i=r.getExtension("OES_texture_half_float_linear")}return r.clearColor(0,0,0,1),n?(a=oe(r,r.RGBA16F,r.RGBA,o,n),l=oe(r,r.RG16F,r.RG,o,n),u=oe(r,r.R16F,r.RED,o,n)):(a={internalFormat:r.RGBA,format:r.RGBA},l={internalFormat:r.RGBA,format:r.RGBA},u={internalFormat:r.RGBA,format:r.RGBA}),{gl:r,ext:{formatRGBA:a,formatRG:l,formatR:u,halfFloatTexType:o,supportLinearFiltering:!!i},isWebGL2:n}}(e);if(!ie)return;const{gl:ae,ext:le,isWebGL2:ue}=ie;function ce(e,t){const r=ae.createShader(e);return ae.shaderSource(r,t),ae.compileShader(r),ae.getShaderParameter(r,ae.COMPILE_STATUS)?r:(console.error("Shader error:",ae.getShaderInfoLog(r)),ae.deleteShader(r),null)}function se(e,t){const r=ce(ae.VERTEX_SHADER,e),n=ce(ae.FRAGMENT_SHADER,t);if(!r||!n)return null;const o=ae.createProgram();if(ae.attachShader(o,r),ae.attachShader(o,n),ae.linkProgram(o),!ae.getProgramParameter(o,ae.LINK_STATUS))return console.error("Program error:",ae.getProgramInfoLog(o)),null;const i={},a=ae.getProgramParameter(o,ae.ACTIVE_UNIFORMS);for(let e=0;e<a;e++){const t=ae.getActiveUniform(o,e).name;i[t]=ae.getUniformLocation(o,t)}return{program:o,uniforms:i}}const fe="\n        precision highp float;\n        attribute vec2 aPosition;\n        varying vec2 vUv;\n        varying vec2 vL;\n        varying vec2 vR;\n        varying vec2 vT;\n        varying vec2 vB;\n        uniform vec2 texelSize;\n        \n        void main () {\n            vUv = aPosition * 0.5 + 0.5;\n            vL = vUv - vec2(texelSize.x, 0.0);\n            vR = vUv + vec2(texelSize.x, 0.0);\n            vT = vUv + vec2(0.0, texelSize.y);\n            vB = vUv - vec2(0.0, texelSize.y);\n            gl_Position = vec4(aPosition, 0.0, 1.0);\n        }\n    ",de="\n        precision highp float;\n        attribute vec2 aPosition;\n        varying vec2 vUv;\n        varying vec2 vL;\n        varying vec2 vR;\n        uniform vec2 texelSize;\n        \n        void main () {\n            vUv = aPosition * 0.5 + 0.5;\n            float offset = 1.33333333;\n            vL = vUv - texelSize * offset;\n            vR = vUv + texelSize * offset;\n            gl_Position = vec4(aPosition, 0.0, 1.0);\n        }\n    ",me={copy:se(fe,"\n        precision mediump float;\n        varying vec2 vUv;\n        uniform sampler2D uTexture;\n        \n        void main () {\n            gl_FragColor = texture2D(uTexture, vUv);\n        }\n    "),clear:se(fe,"\n        precision mediump float;\n        varying vec2 vUv;\n        uniform sampler2D uTexture;\n        uniform float value;\n        \n        void main () {\n            gl_FragColor = value * texture2D(uTexture, vUv);\n        }\n    "),display:se(fe,"\n        precision highp float;\n        varying vec2 vUv;\n        uniform sampler2D uTexture;\n        uniform sampler2D uBloom;\n        uniform bool useBloom;\n        \n        void main () {\n            vec3 c = texture2D(uTexture, vUv).rgb;\n            if (useBloom) {\n                vec3 bloom = texture2D(uBloom, vUv).rgb;\n                c += bloom;\n            }\n            float a = max(c.r, max(c.g, c.b));\n            gl_FragColor = vec4(c, a);\n        }\n    "),bloomPrefilter:se(fe,"\n        precision mediump float;\n        varying vec2 vUv;\n        uniform sampler2D uTexture;\n        uniform vec3 curve;\n        uniform float threshold;\n        \n        void main () {\n            vec3 c = texture2D(uTexture, vUv).rgb;\n            float br = max(c.r, max(c.g, c.b));\n            float rq = clamp(br - curve.x, 0.0, curve.y);\n            rq = curve.z * rq * rq;\n            c *= max(rq, br - threshold) / max(br, 0.0001);\n            gl_FragColor = vec4(c, 0.0);\n        }\n    "),bloomBlur:se(de,"\n        precision mediump float;\n        varying vec2 vL;\n        varying vec2 vR;\n        varying vec2 vUv;\n        uniform sampler2D uTexture;\n        \n        void main () {\n            vec4 sum = vec4(0.0);\n            sum += texture2D(uTexture, vL);\n            sum += texture2D(uTexture, vR);\n            sum *= 0.5;\n            gl_FragColor = sum;\n        }\n    "),bloomFinal:se(de,"\n        precision mediump float;\n        varying vec2 vL;\n        varying vec2 vR;\n        varying vec2 vUv;\n        uniform sampler2D uTexture;\n        uniform float intensity;\n        \n        void main () {\n            vec4 sum = vec4(0.0);\n            sum += texture2D(uTexture, vL);\n            sum += texture2D(uTexture, vR);\n            sum *= 0.5 * intensity;\n            gl_FragColor = sum;\n        }\n    "),splat:se(fe,"\n        precision highp float;\n        varying vec2 vUv;\n        uniform sampler2D uTarget;\n        uniform float aspectRatio;\n        uniform vec3 color;\n        uniform vec2 point;\n        uniform float radius;\n        \n        void main () {\n            vec2 p = vUv - point.xy;\n            p.x *= aspectRatio;\n            vec3 splat = exp(-dot(p, p) / radius) * color;\n            vec3 base = texture2D(uTarget, vUv).xyz;\n            gl_FragColor = vec4(base + splat, 1.0);\n        }\n    "),advection:se(fe,"\n        precision highp float;\n        varying vec2 vUv;\n        uniform sampler2D uVelocity;\n        uniform sampler2D uSource;\n        uniform vec2 texelSize;\n        uniform vec2 dyeTexelSize;\n        uniform float dt;\n        uniform float dissipation;\n        \n        void main () {\n            vec2 coord = vUv - dt * texture2D(uVelocity, vUv).xy * texelSize;\n            vec4 result = texture2D(uSource, coord);\n            float decay = 1.0 + dissipation * dt;\n            gl_FragColor = result / decay;\n        }\n    "),divergence:se(fe,"\n        precision mediump float;\n        varying vec2 vUv;\n        varying vec2 vL;\n        varying vec2 vR;\n        varying vec2 vT;\n        varying vec2 vB;\n        uniform sampler2D uVelocity;\n        \n        void main () {\n            float L = texture2D(uVelocity, vL).x;\n            float R = texture2D(uVelocity, vR).x;\n            float T = texture2D(uVelocity, vT).y;\n            float B = texture2D(uVelocity, vB).y;\n            vec2 C = texture2D(uVelocity, vUv).xy;\n            if (vL.x < 0.0) { L = -C.x; }\n            if (vR.x > 1.0) { R = -C.x; }\n            if (vT.y > 1.0) { T = -C.y; }\n            if (vB.y < 0.0) { B = -C.y; }\n            float div = 0.5 * (R - L + T - B);\n            gl_FragColor = vec4(div, 0.0, 0.0, 1.0);\n        }\n    "),curl:se(fe,"\n        precision mediump float;\n        varying vec2 vUv;\n        varying vec2 vL;\n        varying vec2 vR;\n        varying vec2 vT;\n        varying vec2 vB;\n        uniform sampler2D uVelocity;\n        \n        void main () {\n            float L = texture2D(uVelocity, vL).y;\n            float R = texture2D(uVelocity, vR).y;\n            float T = texture2D(uVelocity, vT).x;\n            float B = texture2D(uVelocity, vB).x;\n            float vorticity = R - L - T + B;\n            gl_FragColor = vec4(0.5 * vorticity, 0.0, 0.0, 1.0);\n        }\n    "),vorticity:se(fe,"\n        precision highp float;\n        varying vec2 vUv;\n        varying vec2 vL;\n        varying vec2 vR;\n        varying vec2 vT;\n        varying vec2 vB;\n        uniform sampler2D uVelocity;\n        uniform sampler2D uCurl;\n        uniform float curl;\n        uniform float dt;\n        \n        void main () {\n            float L = texture2D(uCurl, vL).x;\n            float R = texture2D(uCurl, vR).x;\n            float T = texture2D(uCurl, vT).x;\n            float B = texture2D(uCurl, vB).x;\n            float C = texture2D(uCurl, vUv).x;\n            vec2 force = 0.5 * vec2(abs(T) - abs(B), abs(R) - abs(L));\n            force /= length(force) + 0.0001;\n            force *= curl * C;\n            force.y *= -1.0;\n            vec2 vel = texture2D(uVelocity, vUv).xy;\n            gl_FragColor = vec4(vel + force * dt, 0.0, 1.0);\n        }\n    "),pressure:se(fe,"\n        precision mediump float;\n        varying vec2 vUv;\n        varying vec2 vL;\n        varying vec2 vR;\n        varying vec2 vT;\n        varying vec2 vB;\n        uniform sampler2D uPressure;\n        uniform sampler2D uDivergence;\n        \n        void main () {\n            float L = texture2D(uPressure, vL).x;\n            float R = texture2D(uPressure, vR).x;\n            float T = texture2D(uPressure, vT).x;\n            float B = texture2D(uPressure, vB).x;\n            float C = texture2D(uPressure, vUv).x;\n            float divergence = texture2D(uDivergence, vUv).x;\n            float pressure = (L + R + B + T - divergence) * 0.25;\n            gl_FragColor = vec4(pressure, 0.0, 0.0, 1.0);\n        }\n    "),gradientSubtract:se(fe,"\n        precision mediump float;\n        varying vec2 vUv;\n        varying vec2 vL;\n        varying vec2 vR;\n        varying vec2 vT;\n        varying vec2 vB;\n        uniform sampler2D uPressure;\n        uniform sampler2D uVelocity;\n        \n        void main () {\n            float L = texture2D(uPressure, vL).x;\n            float R = texture2D(uPressure, vR).x;\n            float T = texture2D(uPressure, vT).x;\n            float B = texture2D(uPressure, vB).x;\n            vec2 velocity = texture2D(uVelocity, vUv).xy;\n            velocity.xy -= vec2(R - L, T - B);\n            gl_FragColor = vec4(velocity, 0.0, 1.0);\n        }\n    ")},ve=ae.createBuffer();ae.bindBuffer(ae.ARRAY_BUFFER,ve),ae.bufferData(ae.ARRAY_BUFFER,new Float32Array([-1,-1,-1,1,1,1,1,-1]),ae.STATIC_DRAW);const ge=ae.createBuffer();function he(e,t=!1){null==e?(ae.viewport(0,0,ae.drawingBufferWidth,ae.drawingBufferHeight),ae.bindFramebuffer(ae.FRAMEBUFFER,null)):(ae.viewport(0,0,e.width,e.height),ae.bindFramebuffer(ae.FRAMEBUFFER,e.fbo)),t&&(ae.clearColor(0,0,0,1),ae.clear(ae.COLOR_BUFFER_BIT)),ae.bindBuffer(ae.ARRAY_BUFFER,ve),ae.bindBuffer(ae.ELEMENT_ARRAY_BUFFER,ge),ae.enableVertexAttribArray(0),ae.vertexAttribPointer(0,2,ae.FLOAT,!1,0,0),ae.drawElements(ae.TRIANGLES,6,ae.UNSIGNED_SHORT,0)}let xe,pe,Te,Ee,Re,Se;ae.bindBuffer(ae.ELEMENT_ARRAY_BUFFER,ge),ae.bufferData(ae.ELEMENT_ARRAY_BUFFER,new Uint16Array([0,1,2,0,2,3]),ae.STATIC_DRAW);let be=[];function ye(e){let t=ae.drawingBufferWidth/ae.drawingBufferHeight;t<1&&(t=1/t);const r=Math.round(e),n=Math.round(e*t);return ae.drawingBufferWidth>ae.drawingBufferHeight?{width:n,height:r}:{width:r,height:n}}function De(e,t,r,n,o,i){ae.activeTexture(ae.TEXTURE0);const a=ae.createTexture();ae.bindTexture(ae.TEXTURE_2D,a),ae.texParameteri(ae.TEXTURE_2D,ae.TEXTURE_MIN_FILTER,i),ae.texParameteri(ae.TEXTURE_2D,ae.TEXTURE_MAG_FILTER,i),ae.texParameteri(ae.TEXTURE_2D,ae.TEXTURE_WRAP_S,ae.CLAMP_TO_EDGE),ae.texParameteri(ae.TEXTURE_2D,ae.TEXTURE_WRAP_T,ae.CLAMP_TO_EDGE),ae.texImage2D(ae.TEXTURE_2D,0,r,e,t,0,n,o,null);const l=ae.createFramebuffer();return ae.bindFramebuffer(ae.FRAMEBUFFER,l),ae.framebufferTexture2D(ae.FRAMEBUFFER,ae.COLOR_ATTACHMENT0,ae.TEXTURE_2D,a,0),ae.viewport(0,0,e,t),ae.clear(ae.COLOR_BUFFER_BIT),{texture:a,fbo:l,width:e,height:t,texelSizeX:1/e,texelSizeY:1/t,attach:e=>(ae.activeTexture(ae.TEXTURE0+e),ae.bindTexture(ae.TEXTURE_2D,a),e)}}function Fe(e,t,r,n,o,i){let a=De(e,t,r,n,o,i),l=De(e,t,r,n,o,i);return{width:e,height:t,texelSizeX:a.texelSizeX,texelSizeY:a.texelSizeY,get read(){return a},set read(e){a=e},get write(){return l},set write(e){l=e},swap(){const e=a;a=l,l=e}}}const we=e.closest(".fgb-fluid-group");let _e,Le=0,Be=0;function Me(){const t=we.offsetWidth||300,r=we.offsetHeight||200;if(Math.abs(t-Le)>1||Math.abs(r-Be)>1){const n=4096,o=Math.min(Math.max(t,100),n),i=Math.min(Math.max(r,100),n);return e.width=o,e.height=i,Le=t,Be=r,!0}return!1}function Ae(){const e=ye(J.SIM_RESOLUTION),t=ye(J.DYE_RESOLUTION),r=le.halfFloatTexType,n=le.formatRGBA,o=le.formatRG,i=le.formatR,a=le.supportLinearFiltering?ae.LINEAR:ae.NEAREST;xe=Fe(t.width,t.height,n.internalFormat,n.format,r,a),pe=Fe(e.width,e.height,o.internalFormat,o.format,r,a),Te=De(e.width,e.height,i.internalFormat,i.format,r,ae.NEAREST),Ee=De(e.width,e.height,i.internalFormat,i.format,r,ae.NEAREST),Re=Fe(e.width,e.height,i.internalFormat,i.format,r,ae.NEAREST),function(){const e=ye(J.BLOOM_RESOLUTION),t=le.halfFloatTexType,r=le.formatRGBA,n=le.supportLinearFiltering?ae.LINEAR:ae.NEAREST;Se=De(e.width,e.height,r.internalFormat,r.format,t,n),be.length=0;for(let o=0;o<J.BLOOM_ITERATIONS;o++){const i=e.width>>o+1,a=e.height>>o+1;if(i<2||a<2)break;const l=De(i,a,r.internalFormat,r.format,t,n);be.push(l)}}()}function Oe(){let e;const t=Math.min(K.saturation*K.saturationBoost,1);switch(K.colorMode||"rainbow"){case"rainbow":e=Ue(Math.random(),t,1);break;case"huerange":const r=K.hueMin/360,n=K.hueMax/360;let o;if(r<=n)o=r+Math.random()*(n-r);else{const e=1-r+n;o=r+Math.random()*e,o>1&&(o-=1)}e=Ue(o,t,1);break;case"gradient":ee+=.01*K.gradientSpeed,ee>1&&(ee-=1),e=Ue(ee,t,1);break;default:e=function(e){const t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16)/255,g:parseInt(t[2],16)/255,b:parseInt(t[3],16)/255}:{r:1,g:0,b:1}}(K.fixedColor||"#ff00ff")}if(e.r*=K.brightness,e.g*=K.brightness,e.b*=K.brightness,K.preventOverblending){const t=K.maxColorIntensity;e.r=Math.min(e.r,t),e.g=Math.min(e.g,t),e.b=Math.min(e.b,t)}return K.darkMode&&(e.r=-e.r,e.g=-e.g,e.b=-e.b),e}function Ue(e,t,r){let n,o,i;const a=Math.floor(6*e),l=6*e-a,u=r*(1-t),c=r*(1-l*t),s=r*(1-(1-l)*t);switch(a%6){case 0:n=r,o=s,i=u;break;case 1:n=c,o=r,i=u;break;case 2:n=u,o=r,i=s;break;case 3:n=u,o=c,i=r;break;case 4:n=s,o=u,i=r;break;case 5:n=r,o=u,i=c}return{r:n,g:o,b:i}}window.addEventListener("resize",function(){clearTimeout(_e),_e=setTimeout(function(){Me()&&Ae(),Z()},100)}),$.enabled&&$.trackScroll&&window.addEventListener("scroll",function(){Z()},{passive:!0}),$.enabled&&setTimeout(Z,200),Me(),Ae();let Ce=Date.now();function Pe(t,r,n,o,i){te=Date.now(),ae.useProgram(me.splat.program),ae.uniform1i(me.splat.uniforms.uTarget,pe.read.attach(0)),ae.uniform1f(me.splat.uniforms.aspectRatio,e.width/e.height),ae.uniform2f(me.splat.uniforms.point,t,r),ae.uniform3f(me.splat.uniforms.color,n,o,0),ae.uniform1f(me.splat.uniforms.radius,function(t){const r=e.width/e.height;return r>1&&(t*=r),t}(J.SPLAT_RADIUS/100)),he(pe.write),pe.swap(),ae.uniform1i(me.splat.uniforms.uTarget,xe.read.attach(0)),ae.uniform3f(me.splat.uniforms.color,i.r,i.g,i.b),he(xe.write),xe.swap()}function Ie(t,r,n,o){t.id=r,t.down=!0,t.moved=!1,t.texcoordX=n/e.width,t.texcoordY=1-o/e.height,t.prevTexcoordX=t.texcoordX,t.prevTexcoordY=t.texcoordY,t.deltaX=0,t.deltaY=0,t.color=Oe()}function Ne(t,r,n){if(t.prevTexcoordX=t.texcoordX,t.prevTexcoordY=t.texcoordY,t.texcoordX=r/e.width,t.texcoordY=1-n/e.height,t.deltaX=function(t){const r=e.width/e.height;return r<1&&(t*=r),t}(t.texcoordX-t.prevTexcoordX),t.deltaY=function(t){const r=e.width/e.height;return r>1&&(t/=r),t}(t.texcoordY-t.prevTexcoordY),t.moved=Math.abs(t.deltaX)>0||Math.abs(t.deltaY)>0,t.moved){const r=t.deltaX*e.width,n=t.deltaY*e.height,o=Math.sqrt(r*r+n*n);t.distanceSinceColorChange+=o;const i=K.colorChangeDistance;(0===i||t.distanceSinceColorChange>=i)&&(t.color=Oe(),t.distanceSinceColorChange=0)}}we.addEventListener("mousemove",t=>{const r=ne[0],n=e.getBoundingClientRect();Ne(r,t.clientX-n.left,t.clientY-n.top)}),we.addEventListener("mousedown",()=>{const e=ne[0];e.down=!0,e.color=Oe()}),we.addEventListener("mouseup",()=>{ne[0].down=!1}),t.hideCursor&&(we.style.cursor="none"),we.addEventListener("touchstart",t=>{const r=t.targetTouches;for(;r.length>=ne.length;)ne.push(new re);for(let t=0;t<r.length;t++){const n=e.getBoundingClientRect(),o=r[t].clientX-n.left,i=r[t].clientY-n.top;Ie(ne[t+1],r[t].identifier,o,i)}},{passive:!0}),we.addEventListener("touchmove",t=>{const r=t.targetTouches;for(let t=0;t<r.length;t++){const n=ne[t+1];if(!n||!n.down)continue;const o=e.getBoundingClientRect();Ne(n,r[t].clientX-o.left,r[t].clientY-o.top)}},{passive:!0}),we.addEventListener("touchend",e=>{const t=e.changedTouches;for(let e=0;e<t.length;e++){const r=ne.find(r=>r.id===t[e].identifier);r&&(r.down=!1)}}),function(e){for(let t=0;t<e;t++){const e=Oe();e.r*=10,e.g*=10,e.b*=10,Pe(Math.random(),Math.random(),1e3*(Math.random()-.5),1e3*(Math.random()-.5),e)}}(parseInt(5*Math.random())+5),function t(){const r=function(){const e=Date.now();let t=(e-Ce)/1e3;return t=Math.min(t,.016666),Ce=e,t}();var n;ne.forEach(t=>{t.moved&&(t.moved=!1,function(t){let r=t.deltaX*J.SPLAT_FORCE*J.PROJECTION_DISTANCE,n=t.deltaY*J.SPLAT_FORCE*J.PROJECTION_DISTANCE,o=t.color;if($.enabled&&$.affectNewSplats){const i=function(t,r){if(!$.enabled||0===Q.length)return{blocked:!1,forceX:0,forceY:0,opacity:1};const n=$.mode;let o={blocked:!1,forceX:0,forceY:0,opacity:1};for(const i of Q){const a=t>=i.x&&t<=i.x+i.width,l=r>=i.y&&r<=i.y+i.height,u=a&&l,c=i.x+i.width/2,s=i.y+i.height/2,f=(e.width,e.height,(t-c)*e.width),d=(r-s)*e.height,m=Math.sqrt(f*f+d*d),v=i.pWidth/2,g=i.pHeight/2,h=u?0:Math.max(0,Math.min(Math.abs((t-c)*e.width)-v,Math.abs((r-s)*e.height)-g));switch(n){case"hardCorner":u&&(o.blocked=!0,o.opacity=0);break;case"softEdge":const e=$.softEdgeRadius;u?(o.blocked=!0,o.opacity=0):h<e&&(o.opacity=Math.min(o.opacity,h/e));break;case"forceField":const t=$.forceFieldRadius;if(m<t+v){const e=(1-m/(t+v))*$.forceFieldStrength,r=Math.atan2(d,f);o.forceX+=Math.cos(r)*e,o.forceY+=Math.sin(r)*e}u&&(o.blocked=!0);break;case"attractField":const r=$.attractFieldRadius;if(m<r+v&&!u){const e=(1-m/(r+v))*$.attractFieldStrength,t=Math.atan2(d,f);o.forceX-=Math.cos(t)*e,o.forceY-=Math.sin(t)*e}break;case"turbulence":const n=i.pWidth,a=$.turbulenceIntensity,l=$.turbulenceScale;if(m<2*n&&!u){const e=Math.atan2(d,f)+Math.PI/2,t=(1-m/(2*n))*a;o.forceX+=Math.cos(e)*t*(.5*Math.sin(Date.now()/l)+.5),o.forceY+=Math.sin(e)*t*(.5*Math.cos(Date.now()/l)+.5)}}}return o}(t.texcoordX,t.texcoordY);if(i.blocked)return;r+=i.forceX,n+=i.forceY,o={r:t.color.r*i.opacity,g:t.color.g*i.opacity,b:t.color.b*i.opacity}}Pe(t.texcoordX,t.texcoordY,r,n,o)}(t))}),function(t){ae.disable(ae.BLEND),ae.useProgram(me.curl.program),ae.uniform2f(me.curl.uniforms.texelSize,pe.texelSizeX,pe.texelSizeY),ae.uniform1i(me.curl.uniforms.uVelocity,pe.read.attach(0)),he(Ee),ae.useProgram(me.vorticity.program),ae.uniform2f(me.vorticity.uniforms.texelSize,pe.texelSizeX,pe.texelSizeY),ae.uniform1i(me.vorticity.uniforms.uVelocity,pe.read.attach(0)),ae.uniform1i(me.vorticity.uniforms.uCurl,Ee.attach(1)),ae.uniform1f(me.vorticity.uniforms.curl,J.CURL),ae.uniform1f(me.vorticity.uniforms.dt,t),he(pe.write),pe.swap(),ae.useProgram(me.divergence.program),ae.uniform2f(me.divergence.uniforms.texelSize,pe.texelSizeX,pe.texelSizeY),ae.uniform1i(me.divergence.uniforms.uVelocity,pe.read.attach(0)),he(Te),ae.useProgram(me.clear.program),ae.uniform1i(me.clear.uniforms.uTexture,Re.read.attach(0)),ae.uniform1f(me.clear.uniforms.value,J.PRESSURE),he(Re.write),Re.swap(),ae.useProgram(me.pressure.program),ae.uniform2f(me.pressure.uniforms.texelSize,pe.texelSizeX,pe.texelSizeY),ae.uniform1i(me.pressure.uniforms.uDivergence,Te.attach(0));for(let e=0;e<J.PRESSURE_ITERATIONS;e++)ae.uniform1i(me.pressure.uniforms.uPressure,Re.read.attach(1)),he(Re.write),Re.swap();ae.useProgram(me.gradientSubtract.program),ae.uniform2f(me.gradientSubtract.uniforms.texelSize,pe.texelSizeX,pe.texelSizeY),ae.uniform1i(me.gradientSubtract.uniforms.uPressure,Re.read.attach(0)),ae.uniform1i(me.gradientSubtract.uniforms.uVelocity,pe.read.attach(1)),he(pe.write),pe.swap(),ae.useProgram(me.advection.program),ae.uniform2f(me.advection.uniforms.texelSize,pe.texelSizeX,pe.texelSizeY),ae.uniform2f(me.advection.uniforms.dyeTexelSize,pe.texelSizeX,pe.texelSizeY);const r=pe.read.attach(0);ae.uniform1i(me.advection.uniforms.uVelocity,r),ae.uniform1i(me.advection.uniforms.uSource,r),ae.uniform1f(me.advection.uniforms.dt,t);let n=J.VELOCITY_DISSIPATION;if(J.CALM_DOWN){const e=Date.now()-te;if(e>J.CALM_DOWN_DELAY){const t=Math.min((e-J.CALM_DOWN_DELAY)/1e3,1);n=J.VELOCITY_DISSIPATION*(1-t)+J.CALM_DOWN_STRENGTH*t}}ae.uniform1f(me.advection.uniforms.dissipation,n),he(pe.write),pe.swap(),ae.uniform2f(me.advection.uniforms.dyeTexelSize,xe.texelSizeX,xe.texelSizeY),ae.uniform1i(me.advection.uniforms.uVelocity,pe.read.attach(0)),ae.uniform1i(me.advection.uniforms.uSource,xe.read.attach(1));const o=J.DENSITY_DISSIPATION/J.FADE_SPEED;ae.uniform1f(me.advection.uniforms.dissipation,o),he(xe.write),xe.swap(),$.enabled&&$.affectExistingFluid&&Q.length>0&&function(){const t=$.mode;for(const r of Q){const n=r.x+r.width/2,o=r.y+r.height/2;switch(t){case"hardCorner":case"softEdge":const i="softEdge"===t?.5*Math.max(r.width,r.height)+$.softEdgeRadius/e.width:.4*Math.max(r.width,r.height);ae.useProgram(me.splat.program),ae.uniform1i(me.splat.uniforms.uTarget,pe.read.attach(0)),ae.uniform1f(me.splat.uniforms.aspectRatio,e.width/e.height),ae.uniform2f(me.splat.uniforms.point,n,o),ae.uniform3f(me.splat.uniforms.color,0,0,0),ae.uniform1f(me.splat.uniforms.radius,.5*i),he(pe.write),pe.swap(),ae.uniform1i(me.splat.uniforms.uTarget,xe.read.attach(0));const a="softEdge"===t?-.02:-.05;ae.uniform3f(me.splat.uniforms.color,a,a,a),ae.uniform1f(me.splat.uniforms.radius,.5*i),he(xe.write),xe.swap();break;case"forceField":const l=$.forceFieldRadius/e.width+.5*r.width,u=.01*$.forceFieldStrength;ae.useProgram(me.splat.program),ae.uniform1i(me.splat.uniforms.uTarget,pe.read.attach(0)),ae.uniform1f(me.splat.uniforms.aspectRatio,e.width/e.height),ae.uniform2f(me.splat.uniforms.point,n,o),ae.uniform3f(me.splat.uniforms.color,u,u,0),ae.uniform1f(me.splat.uniforms.radius,l),he(pe.write),pe.swap();break;case"attractField":const c=$.attractFieldRadius/e.width+.5*r.width,s=.005*-$.attractFieldStrength;ae.useProgram(me.splat.program),ae.uniform1i(me.splat.uniforms.uTarget,pe.read.attach(0)),ae.uniform1f(me.splat.uniforms.aspectRatio,e.width/e.height),ae.uniform2f(me.splat.uniforms.point,n,o),ae.uniform3f(me.splat.uniforms.color,s,s,0),ae.uniform1f(me.splat.uniforms.radius,c),he(pe.write),pe.swap();break;case"turbulence":const f=r.width+$.turbulenceIntensity/e.width,d=.001*$.turbulenceIntensity,m=Date.now()/$.turbulenceScale,v=Math.sin(m)*d;ae.useProgram(me.splat.program),ae.uniform1i(me.splat.uniforms.uTarget,pe.read.attach(0)),ae.uniform1f(me.splat.uniforms.aspectRatio,e.width/e.height),ae.uniform2f(me.splat.uniforms.point,n,o),ae.uniform3f(me.splat.uniforms.color,v,.5*-v,0),ae.uniform1f(me.splat.uniforms.radius,f),he(pe.write),pe.swap()}}}()}(r),n=null,J.BLOOM&&be.length>=2&&function(e,t){if(be.length<2)return;let r=t;ae.disable(ae.BLEND),ae.useProgram(me.bloomPrefilter.program);const n=J.BLOOM_THRESHOLD*J.BLOOM_SOFT_KNEE+1e-4,o=J.BLOOM_THRESHOLD-n,i=2*n,a=.25/n;ae.uniform3f(me.bloomPrefilter.uniforms.curve,o,i,a),ae.uniform1f(me.bloomPrefilter.uniforms.threshold,J.BLOOM_THRESHOLD),ae.uniform1i(me.bloomPrefilter.uniforms.uTexture,e.attach(0)),he(r),ae.useProgram(me.bloomBlur.program);for(let e=0;e<be.length;e++){const t=be[e];ae.uniform2f(me.bloomBlur.uniforms.texelSize,r.texelSizeX,r.texelSizeY),ae.uniform1i(me.bloomBlur.uniforms.uTexture,r.attach(0)),he(t),r=t}ae.blendFunc(ae.ONE,ae.ONE),ae.enable(ae.BLEND);for(let e=be.length-2;e>=0;e--){const t=be[e];ae.uniform2f(me.bloomBlur.uniforms.texelSize,r.texelSizeX,r.texelSizeY),ae.uniform1i(me.bloomBlur.uniforms.uTexture,r.attach(0)),ae.viewport(0,0,t.width,t.height),he(t),r=t}ae.disable(ae.BLEND),ae.useProgram(me.bloomFinal.program),ae.uniform2f(me.bloomFinal.uniforms.texelSize,r.texelSizeX,r.texelSizeY),ae.uniform1i(me.bloomFinal.uniforms.uTexture,r.attach(0)),ae.uniform1f(me.bloomFinal.uniforms.intensity,J.BLOOM_INTENSITY),he(t)}(xe.read,Se),function(e){const t=null==e?ae.drawingBufferWidth:e.width,r=null==e?ae.drawingBufferHeight:e.height;ae.useProgram(me.display.program),ae.uniform2f(me.display.uniforms.texelSize,1/t,1/r),ae.uniform1i(me.display.uniforms.uTexture,xe.read.attach(0)),J.BLOOM&&be.length>=2?(ae.uniform1i(me.display.uniforms.uBloom,Se.attach(1)),ae.uniform1i(me.display.uniforms.useBloom,1)):ae.uniform1i(me.display.uniforms.useBloom,0),he(e)}(n),requestAnimationFrame(t)}()}(t,n)})});